#!/usr/bin/env ruby

libdir = File.expand_path(File.dirname(__FILE__))
require "#{libdir}/../lib/sfpagent"

opts = Trollop::options do
	version "sfpagent 0.0.1 (c) 2013 Herry"
	banner <<-EOS
SFP Agent that provides a Ruby framework for managing system configurations.

Usage:
       sfpagent [options] [model-file]

where [options] are:
EOS

	opt :start, "Start the daemon agent."
	opt :stop, "Stop the daemon agent."
	opt :status, "Print the status of the daemon agent."
	opt :state, "Load the runtime modules and then print their states in JSON. [model-file] shoud be specified."
	opt :execute, "Execute a plan in given file."
end

def parse(filepath)
	home_dir = File.expand_path(File.dirname(filepath))
	parser = Sfp::Parser.new({:home_dir => home_dir})
	parser.parse(File.read(filepath))
	parser
end

filepath = ARGV[0].to_s

if opts[:start]
	Sfp::Agent.start

elsif opts[:stop]
	Sfp::Agent.stop

elsif opts[:status]
	Sfp::Agent.status

elsif opts[:state]
	abort "[model-file] is not specified!\nUse \"sfpagent -h\" for more details.\n" if filepath == ''

	state = Sfp::Runtime.new(parse(filepath)).get_state
	puts JSON.pretty_generate(state)

elsif opts[:execute]
	abort "[model-file] is not specified!\nUse \"sfpagent -h\" for more details.\n" if filepath == ''

	abort "Not yet implemented!"

else
	Trollop::help

end
